<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Data Viewer</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">

    <!-- Custom CSS -->
    <style>
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #6c757d;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
        }
        .card {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        /* Additional custom styles if needed */
    </style>

    <!-- Firebase JS SDK -->
    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, orderBy, limit, getDocs, startAfter } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA2Uf5nXzvN5aSRL0iaOepYxOW6m7e2yjM",
            authDomain: "fbproject-c27b4.firebaseapp.com",
            databaseURL: "https://fbproject-c27b4-default-rtdb.firebaseio.com",
            projectId: "fbproject-c27b4",
            storageBucket: "fbproject-c27b4.appspot.com",
            messagingSenderId: "1008151670205",
            appId: "1:1008151670205:web:231a4bf7573ccd5a7ef6d4",
            measurementId: "G-VXYKQYFG9G"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let lastVisible = null;
        let isFetching = false;

        // Register new user
        async function registerUser() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                currentUser = userCredential.user;
                console.log('User registered:', currentUser);

                // Create initial user document in Firestore
                await setDoc(doc(db, 'users', currentUser.uid), {
                    email: currentUser.email,
                    name: "",
                    age: "",
                    weight: ""
                });

                alert("User registered successfully!");
                bootstrap.Modal.getInstance(document.getElementById('authModal')).hide();
                fetchUserData();
            } catch (error) {
                console.error("Error registering user:", error);
                alert(error.message);
            }
        }

        // Sign in user
        async function signInUser() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                currentUser = userCredential.user;
                console.log('User signed in:', currentUser);
                bootstrap.Modal.getInstance(document.getElementById('authModal')).hide();
                fetchUserData();
            } catch (error) {
                console.error("Error signing in:", error);
                alert(error.message);
            }
        }

        // Fetch user data from Firestore and display in table
        async function fetchUserData() {
            try {
                const docRef = doc(db, 'users', currentUser.uid);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('name').textContent = data.name || '';
                    document.getElementById('age').textContent = data.age || '';
                    document.getElementById('weight').textContent = data.weight || '';
                } else {
                    console.log("No such document!");
                }
            } catch (error) {
                console.error("Error fetching data:", error);
            }
        }

        // Update user data in Firestore
        async function updateUserData() {
            const name = document.getElementById('name').textContent;
            const age = document.getElementById('age').textContent;
            const weight = document.getElementById('weight').textContent;

            try {
                await updateDoc(doc(db, 'users', currentUser.uid), {
                    name: name,
                    age: age,
                    weight: weight
                });

                alert("User data updated successfully!");
            } catch (error) {
                console.error("Error updating data:", error);
            }
        }

        // Load data from Firestore with lazy loading
        async function loadData(collectionName, reset = true) {
            if (isFetching) return;
            isFetching = true;

            // Show the loading spinner
            document.getElementById('loadingSpinner').style.display = 'block';

            if (reset) {
                lastVisible = null;
                document.getElementById('contentArea').innerHTML = '';
            }

            const contentArea = document.getElementById('contentArea');
            const collRef = collection(db, collectionName);
            let q;

            if (lastVisible) {
                q = query(collRef, orderBy('createdAt', 'desc'), startAfter(lastVisible), limit(10));
            } else {
                q = query(collRef, orderBy('createdAt', 'desc'), limit(10));
            }

            try {
                const querySnapshot = await getDocs(q);
                let items = [];

                querySnapshot.forEach((doc) => {
                    items.push({ id: doc.id, data: doc.data() });
                });

                if (items.length > 0) {
                    lastVisible = querySnapshot.docs[querySnapshot.docs.length - 1];
                    displayData(items, collectionName);
                } else if (reset) {
                    contentArea.innerHTML = '<p class="text-center">No profiles available.</p>';
                }
            } catch (error) {
                console.error("Error fetching profiles:", error);
                displayErrorMessage(`Error: ${error.message}`);
            } finally {
                isFetching = false;
                // Hide the loading spinner
                document.getElementById('loadingSpinner').style.display = 'none';
            }
        }

        // Display data in an elegant format
        function displayData(items, collectionName) {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = '';  // Clear previous content

            items.forEach(item => {
                const { firstname, lastname, handle, followersCount, followingCount, quickieCount, avatarUrl, bio, coverPhoto } = item.data;

                const col = document.createElement('div');
                col.className = 'col-12 col-md-6 mb-4';

                const card = document.createElement('div');
                card.className = 'card';

                // Card Cover Photo
                if (coverPhoto) {
                    const coverPhotoDiv = document.createElement('div');
                    coverPhotoDiv.className = 'card-img-top';
                    coverPhotoDiv.style.height = '150px';
                    coverPhotoDiv.style.backgroundImage = `url(${coverPhoto})`;
                    coverPhotoDiv.style.backgroundSize = 'cover';
                    coverPhotoDiv.style.backgroundPosition = 'center';
                    card.appendChild(coverPhotoDiv);
                }

                // Card Header with Avatar, Name, and Handle
                const cardHeader = document.createElement('div');
                cardHeader.className = 'card-header d-flex align-items-center';

                // Avatar
                const avatar = document.createElement('img');
                avatar.className = 'rounded-circle me-3';
                avatar.src = avatarUrl || 'https://via.placeholder.com/50';
                avatar.alt = 'Avatar';
                avatar.style.width = '50px';
                avatar.style.height = '50px';

                const fullNameAndHandle = document.createElement('div');
                const fullName = document.createElement('strong');
                fullName.textContent = `${firstname || 'Unknown'} ${lastname || 'User'}`;
                const handleSpan = document.createElement('span');
                handleSpan.textContent = ` @${handle || 'handle'}`;
                handleSpan.className = 'text-muted ms-2';

                fullNameAndHandle.appendChild(fullName);
                fullNameAndHandle.appendChild(handleSpan);

                cardHeader.appendChild(avatar);
                cardHeader.appendChild(fullNameAndHandle);

                // Card Body
                const cardBody = document.createElement('div');
                cardBody.className = 'card-body';

                const bioParagraph = document.createElement('p');
                bioParagraph.textContent = bio || 'No bio available';
                bioParagraph.className = 'text-muted';

                const followers = document.createElement('p');
                followers.textContent = `Followers: ${followersCount || 0}`;

                const following = document.createElement('p');
                following.textContent = `Following: ${followingCount || 0}`;

                const quickies = document.createElement('p');
                quickies.textContent = `Quickies: ${quickieCount || 0}`;

                cardBody.appendChild(bioParagraph);
                cardBody.appendChild(followers);
                cardBody.appendChild(following);
                cardBody.appendChild(quickies);

                // Assemble the card
                card.appendChild(cardHeader);
                card.appendChild(cardBody);
                col.appendChild(card);

                contentArea.appendChild(col);
            });
        }



        // Infinite scroll for lazy loading
        window.addEventListener('scroll', () => {
            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500 && !isFetching) {
                const activeButton = document.querySelector('.btn.active');
                if (activeButton) {
                    loadData(activeButton.dataset.collection, false);
                }
            }
        });

        // Initialize event listeners on window load
        window.onload = function() {
            const authModal = new bootstrap.Modal(document.getElementById('authModal'));

            // Authentication state observer
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    console.log('User is signed in:', currentUser);
                    // Hide the modal if user is signed in
                    bootstrap.Modal.getInstance(document.getElementById('authModal')).hide();
                    fetchUserData();
                } else {
                    console.log('No user is signed in');
                    // Show the modal only if no user is signed in
                    const authModalInstance = new bootstrap.Modal(document.getElementById('authModal'), {
                        backdrop: 'static',
                        keyboard: false
                    });
                    authModalInstance.show();
                }
            });

            document.getElementById('registerUser').addEventListener('click', registerUser);
            document.getElementById('signInUser').addEventListener('click', signInUser);

            // Section buttons
            const buttons = document.querySelectorAll('.section-button');

            buttons.forEach(button => {
                button.addEventListener('click', () => {
                    // Remove active class from all buttons
                    buttons.forEach(btn => btn.classList.remove('active'));
                    // Add active class to the clicked button
                    button.classList.add('active');
                    // Load data
                    loadData(button.dataset.collection);
                });
            });
        };


    </script>

    <!-- Bootstrap 5.3.3 JS (for Modal functionality) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

</head>
<body>

    <!-- Authentication Modal -->
    <div class="modal fade" id="authModal" tabindex="-1" aria-labelledby="authModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="authModalLabel">Please Login</h5>
          </div>
          <div class="modal-body">
            <!-- User Authentication Section -->
            <div class="container">
              <div class="mb-3">
                <label for="email" class="form-label">Email:</label>
                <input type="email" id="email" class="form-control" placeholder="Enter your email">
              </div>
              <div class="mb-3">
                <label for="password" class="form-label">Password:</label>
                <input type="password" id="password" class="form-control" placeholder="Enter your password">
              </div>
              <div class="d-grid gap-2">
                <button id="registerUser" class="btn btn-primary">Register User</button>
                <button id="signInUser" class="btn btn-success">Sign In User</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="container mt-5">
        <h1 class="text-center">Firebase Data Viewer</h1>

        <!-- Section Buttons -->
        <div class="d-flex justify-content-center my-4">
            <button class="btn btn-outline-secondary mx-2 section-button" data-collection="profiles">Profiles</button>
        </div>

        <!-- Content Display Area -->
        <div id="contentArea" class="row"></div>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="text-center my-4" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        </div>

        
    </div>

</body>
</html>